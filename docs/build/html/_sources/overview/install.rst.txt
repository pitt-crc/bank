Install and Setup
=================

Prerequisites
-------------

You will need the following utilities installed

- Slurm: 17.11.7 is recommended, but most of the queries should work for
  older, and newer, versions.
- SMTP: A working SMTP server to send emails via `smtplib` in python.

Installing Source Code
----------------------

.. code-block:: bash

   git clone https://github.com/pitt-crc/bank
   pip install -r requirements.txt

Configuring Slurm
-----------------

In your Slurm configuration you will need to configure the following:

.. code-block::

   PriorityDecayHalfLife=0-00:00:00
   PriorityUsageResetPeriod=NONE


Slurm Accounts
^^^^^^^^^^^^^^

By default, when you create an account:

.. code-block:: bash

   sacctmgr add account barrymoo
   sacctmgr list account

      Account                Descr                  Org
   ---------- -------------------- --------------------
     barrymoo             barrymoo             barrymoo

The script pulls the description and turns it into an email address to notify
users. Removing the ``@<email.com>`` can be done but is not necessary. To do
this for existing accounts (if you are unsure):

.. code-block:: bash

   sacctmgr update account where account=barrymoo set description="<email>"

Slurm Associations
^^^^^^^^^^^^^^^^^^

If you have multiple Slurm clusters, this tool was designed to provide a single
bank account for all of them. Obviously, you can modify the script to enforce
them separately or use multiple versions. It is recommended to explicitly define
all available clusters (especially if you have some clusters for which there is
no banking enforcement),

.. code-block:: bash 

   sacctmgr add account barrymoo description="<email>" cluster=<cluster/s>


Available Applications
^^^^^^^^^^^^^^^^^^^^^^

.. list-table:: Application Settings
:widths: 25 25 50
*  - Environmental Variable 
   - Default Setting Value
   - Description of Setting

* - BANK_IS_TESTING
  - False
  - Parent Application setting for testing proposal for an account

* - BANK_DATE_FORMAT
  - "%m/%d/%y"
  - Format the date in application setting  

* - BANK_APPLICATION_DIR
  - Path(__file__).resolve().parent
  - Where and how to write log files to

* - BANK_LOG_PATH
  - _application_dir / 'crc_bank.log'
  - Where and how to write log files to

* - BANK_LOG_FORMAT
  - '[%(levelname)s] %(asctime)s - %(name)s - %(message)s'
  - Where and how to write log files to

* - BANK_LOG_LEVEL
  - 'INFO'
  - Where and how to write log files to

* - BANK_DB_PATH
  - f'sqlite:///{_application_dir / "crc_bank.db"}'
  - Path to the application SQLite backend

* - BANK_DB_TEST_PATH
  - f'sqlite:///{_application_dir / "test.db"}'
  - Path to the application SQLite backend

* - BANK_CLUSTERS
  - ("smp", "mpi", "gpu", "htc")
  - A list of cluster names to track usage on

* - BANK_EMAIL_SUFFIX
  - "@pitt.edu"
  - The email suffix for your organizations


* - BANK_NOTIFY_LEVELS
  - (25, 50, 75, 90)
  - The levels in whih an account can reach in proposal threshold


* - BANK_NOTIFY_SUS_LIMIT_EMAIL_TEXT 
  - """\
  - Email format to notify account about service units usage and limit

* - BANK_THREE_MONTH_PROPOSAL_EXPIRY_NOTIFICATION_EMAIL 
  - """\
  - An email to send when you are 90 days from the end of your proposal
   

* - BANK_PROPOSAL_EXPIRES_NOTIFICATION_EMAIL
  - """\
  - An email to send when the proposal has expired
 
