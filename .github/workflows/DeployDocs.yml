name: Deploy Documentation

on:
  workflow_dispatch:
  push:
    branches: [ development ]

jobs:
  Build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        fetch-depth: 0 # Otherwise, you will fail to push refs to destination repo
      
    - name: Install dependencies
      run: |
        conda activate bank_docs
        pip install -r requirements.txt
        pip install -r docs/requirements.txt
   
    - name: Build and commit
      uses: sphinx-notes/pages@master
      run: |
        conda activate bank_docs
        tmp_dir=$(mktemp -d -t pages-XXXXXXXXXX)
        
        echo Building docs
        make -f docs/Makefile html
        cp -vr docs/build/* $temp_dir
        
        echo Updating repo contents
        git checkout --force gh-pages
        rm -vrf * 
        rm -rf $tmp_dir/.doctrees # Remove unused doctree
        cp -vr $tmp_dir/. .
        
        echo Adding HTML documentation to repository index
        git add .
        echo Recording changes to repository
        git commit --allow-empty -m "Add changes for $GITHUB_SHA"

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: gh-pages
